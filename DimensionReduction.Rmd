---
title: "Dimension Reduction"
author: "Alex Faassen"
date: "2025-03-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**To Do:**
- Determine effective dimension reduction methods, likely PCA and/or variants.
  - Sparse PCA?
- Perform on images and analyze results
- Attach output to stats dataset and store

# Setup

```{r}
## Load Data
load("Data/pokemon.RData")

## Libraries
library(ggplot2)
library(ggfortify)
library(patchwork)

## Helper functions
barplot = function(values){
  n = length(values)
  df = data.frame(value = values,  index = 1:n)
  ggplot(df, aes(index, value, fill = value)) + 
    geom_bar(color = "black", stat = "identity")+
    scale_fill_gradient2(low="#619CFF", mid="white", high="#F8766D")+
    theme_bw()
}

# heatmap = function(A){
#   n = nrow(A)
#   p = ncol(A)  
#   df = data.frame(value = c(A),  i = 1:n, j = rep(1:p, rep(n, p)))
#   ggplot(df, aes(j, i, fill = value)) + 
#     geom_tile(color = "black")+
#     scale_fill_gradient2(low="#619CFF", mid="white", high="#F8766D")+
#     scale_y_reverse()+
#     theme_void()
# }

getImg = function(flat_img){
  # matrix(unlist(gsvalues), 120, 120, 4, byrow = T)
  # rasterGrob(array(flat_img, dim = c(120, 120, 4)))
  array(as.numeric(flat_img), dim = c(120, 120, 4))
}

plotImg <- function(img_raster) {
  # Plot using ggplot2
  ggplot() +
    annotation_raster(img_raster, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
    theme_void()  # Remove axes for clean visualization
}
```

# PCA

```{r}
## PCA
# Defaults: center = TRUE, scale. = FALSE
PCA = prcomp(images[,-1], center = TRUE, scale = FALSE) #scale = TRUE)

sum_PCA = summary(PCA)
```

```{r}
## Biplot
# Colours
stats$type1 = factor(stats$type1)
# unique(stats$type1)
# type_colours = c("#A6B91A", "#705746", "#6F35FC", "#")
type_colours = c("#7AC74C", "#EE8130", "#6390F0", "#A6B91A", "#A8A77A", "#A33EA1",
            "#F7D02C", "#E2BF65", "#D685AD", "#CC2E28", "#F95587", "#B6A136", "#735797",
            "#96D9D6", "#6F35FC", "#705746", "#B7B7CE", "#A98FF3")
names(type_colours) = unique(stats$type1)

# library(ggfortify)
autoplot(PCA, data = cbind(stats$name, stats$type1, images[,-1]), shape = FALSE, color = "stats$type1", label = TRUE, label.label = "stats$name", scale = 0) +
  scale_colour_manual(values = type_colours) +
  theme(legend.position = "none")
```

## Loading Vectors

```{r}
## Smallest PC1 Pokemon
# Extract PCA-transformed data
pca_data <- as.data.frame(PCA$x)  # Convert PCA results to a data frame

# Add Pokémon names and types for reference
pca_data$name <- stats$name  # Ensure stats$name contains Pokémon names
pca_data$type1 <- stats$type1  # Primary type for reference

# Sort by PC1 in ascending order and select the two smallest
smallest_pc1_pokemon <- pca_data[order(pca_data$PC1), ][1:2, ]

# Print result
print(rownames(smallest_pc1_pokemon))
```

```{r}
## PC1
# Extremes
pos1 = plotImg(getImg(images[stats$name == "Wailord", -1]))
pos2 = plotImg(getImg(images[stats$name == "Abomasnow", -1]))
neg1 = plotImg(getImg(images[stats$name == "Elgyem", -1])) # Pikipek
neg2 = plotImg(getImg(images[stats$name == "Geodude", -1])) # Unown
# exPlots = sapply(c(pos1, pos2, neg1, neg2), function(rgba) plotImg(getImg(rgba)))
# (pos1 + pos2) / (neg1 + neg2)
final_plot = (pos1 + labs(title = "Most Positive PC1: Wailord") +
              pos2 + labs(title = "Second Positive PC1: Abomasnow")) /
             (neg1 + labs(title = "Most Negative PC1: Elgyem") +
              neg2 + labs(title = "Second Negative PC1: Geodude"))
print(final_plot)

# Loading Vector
pca = PCA$rotation[,1]
pca_norm = (pca - min(pca)) / (max(pca) - min(pca))
# pca_norm = (pca - mean(pca))/(2 * sd(pca))
plotImg(getImg(pca_norm))
```

```{r}
## PC1
# Extremes
pos1 = plotImg(getImg(images[stats$name == "Slowking", -1]))
pos2 = plotImg(getImg(images[stats$name == "Gardevoir", -1]))
neg1 = plotImg(getImg(images[stats$name == "Altaria", -1]))
neg2 = plotImg(getImg(images[stats$name == "Swablu", -1]))
# exPlots = sapply(c(pos1, pos2, neg1, neg2), function(rgba) plotImg(getImg(rgba)))
(pos1 + pos2) / (neg1 + neg2)

# Loading Vector
pca = PCA$rotation[,2]
pca_norm = (pca - min(pca)) / (max(pca) - min(pca))
plotImg(getImg(pca_norm))
```

# Variance Explained

```{r}
## Variance Explained
ve = summary(PCA)$importance[3,]

# Plot
barplot(ve)+
  xlab("principal component")+
  ylab("cumulative variance explained")+
  ylim(0, 1)+
  geom_hline(aes(yintercept = 0.9), linewidth = 1, linetype = "dashed") +
  geom_hline(aes(yintercept = 0.95), linewidth = 1, linetype = "dashed", color = "red") +
  geom_vline(xintercept = num_pcs, linetype = "dotted", color = "blue") +  # Highlight selected PC count
  annotate("text", x = num_pcs + 5, y = 0.5, label = paste0(num_pcs, " PCs retained"), color = "blue")

## Retain PCs
var_retain = 0.95 # 95% of VE
num_pcs = min(which(ve >= var_retain)); num_pcs
dr_images = data.frame(
  image_path = images$image_path,
  PCA$x[,1:num_pcs]
)
```

# Save Dataset

```{r}
## Save Dataset
save(stats, dr_images, file = "Data/dr_pokemon.RData")
```

# Local Dimension Reduction

```{r}
#
```

