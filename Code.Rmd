---
title: "Predicting Pokémon Types Using Clustering and Classification"
subtitle: "Code Submission"
author: "Justin Zhang, Isaac Baguisa, Alex Faassen"
date: "2025-04-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Note:** Commented out unnecessary "test" outputs.

# Data

## Pre-processing

```{r}
library(png)
library(ggplot2)
library(dplyr)

setwd("Data")

## Load Stats
stats = read.csv("pokemon_stats.csv", header = TRUE)
# Check
# str(stats)
# Image path
stats$image_path = paste0("images/", tolower(stats$name.simple), ".png")
# Check
# head(stats$image_path)

## Load Image Registry
img_reg = read.csv("pokemon_img.csv", header = TRUE)
# Has Image
stats$has_img = tolower(stats$name.simple) %in% img_reg$Name
# No Img
stats[!stats$has_img, "name"]

## Load Images
# Test: Abomasnow
abomasnow = readPNG("images/abomasnow.png")
ggplot()+
  annotation_raster(abomasnow,xmin=-Inf,xmax=+Inf,ymin=-Inf,ymax= +Inf)
# Pixels
# str(abomasnow)
pix = prod(dim(abomasnow)[1:2])

# Image List
image_list = list.files("images", pattern = "*.png") %>% paste("images/", ., sep = "")

# Helper fn
flatten_img = function(img_path) {
  img = readPNG(img_path) # Read image as raster array (dim: [120, 120, 4])
  return(as.vector(img[,,-4])) # Flatten to vector + Remove Alpha
}

# Image Dataset
images = sapply(image_list, flatten_img) %>% t() %>% as.data.frame() %>%
  mutate(image_path = image_list) %>% select(image_path, everything())
# colnames(images) = c("image_path", rep())
# Check
images[1:5, 1:5]
# str(images)

## Match Datasets
# Match the rows to represent the same pokemon, in the same order.
images = images %>%
  semi_join(stats, by = "image_path") %>%
  arrange(match(image_path, stats$image_path))
# Check
mean(stats$image_path == images$image_path)

## Save Datasets
# save(stats, images, file = "pokemon.RData")

setwd("..")
```

## EDA Visuals

```{r}
# Libraries
library(png)
library(ggplot2)
library(patchwork)

## Example Pokemon
ex1 = readPNG("Data/images/pikachu.png")
ex2 = readPNG("Data/images/charizard.png")
p1 = ggplot()+
  annotation_raster(ex1,xmin=-Inf,xmax=+Inf,ymin=-Inf,ymax= +Inf) +
  labs(title = "Pikachu (Primary Type: Electric)")
p2 = ggplot()+
  annotation_raster(ex2,xmin=-Inf,xmax=+Inf,ymin=-Inf,ymax= +Inf) +
  labs(title = "Charizard (Primary Type: Fire)")
p1 + p2



## Top Pokemon Types: Bar Chart + Attack Boxplot
type_cols <- c(
  "bug" = "#A8B820", "dark" = "#705848", "dragon" = "#7038F8", "electric" = "#F8D030",
  "fairy" = "#EE99AC", "fighting" = "#C03028", "fire" = "#F08030", "flying" = "#A890F0",
  "ghost" = "#705898", "grass" = "#78C850", "ground" = "#E0C068", "ice" = "#98D8D8",
  "normal" = "#A8A878", "poison" = "#A040A0", "psychic" = "#F85888", "rock" = "#B8A038",
  "steel" = "#B8B8D0", "water" = "#6890F0"
)

# Top N primary types (by freq)
top5_types <- stats %>%
  mutate(type1 = tolower(type1)) %>%
  count(type1, sort = TRUE) %>%
  top_n(5, n)

filtered_data <- stats %>%
  mutate(type1 = tolower(type1)) %>%
  filter(type1 %in% top5_types$type1) %>%
  mutate(type1 = fct_infreq(type1)) 

# Bar chart of pokemon by primary type
type_freq = ggplot(filtered_data, aes(x = fct_infreq(type1), fill = type1)) +
  geom_bar() +
  scale_fill_manual(values = type_cols) +
  labs(
    title = "Top 5 Pokémon Types",
    x = "Primary Type",
    y = "Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "left")

# Boxplot of Attack by Type
type_attack = ggplot(filtered_data, aes(x = type1, y = attack, fill = type1)) +
  geom_boxplot() +
  scale_fill_manual(values = type_cols) +
  labs(
    title = "Attack Stat Distributions",
    x = "Primary Type",
    y = "Attack Stat"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

## Table of summary stats for key features
key_features <- c("hp", "attack", "defense", "sp_attack", "sp_defense", "speed", "height_m", "weight_kg")

# Summary stats
summary_table <- stats %>%
  select(all_of(key_features)) %>%
  summarise(across(everything(), list(
    mean = ~round(mean(.x, na.rm = TRUE), 2),
    sd = ~round(sd(.x, na.rm = TRUE), 2),
    min = ~min(.x, na.rm = TRUE),
    q1 = ~quantile(.x, 0.25, na.rm = TRUE),
    median = ~median(.x, na.rm = TRUE),
    q3 = ~quantile(.x, 0.75, na.rm = TRUE),
    max = ~max(.x, na.rm = TRUE)
  ), .names = "{.col}_{.fn}")) %>%
  pivot_longer(cols = everything(),
               names_to = c("Feature", "Statistic"),
               names_pattern = "^(.*)_(mean|sd|min|q1|median|q3|max)$",
               values_to = "Value") %>%
  pivot_wider(names_from = Statistic, values_from = Value)

# Save
save(p1, p2, type_freq, type_attack, summary_table, file = "Figures/data_description.RData")
```

# Image Dimension Reduction

```{r}
library(patchwork)
library(ggfortify)

## Helper functions
barplot = function(values){
  n = length(values)
  df = data.frame(value = values,  index = 1:n)
  ggplot(df, aes(index, value, fill = value)) + 
    geom_bar(color = "black", stat = "identity")+
    scale_fill_gradient2(low="#619CFF", mid="white", high="#F8766D")+
    theme_bw()
}

getImg = function(flat_img){
  # matrix(unlist(gsvalues), 120, 120, 4, byrow = T)
  # rasterGrob(array(flat_img, dim = c(120, 120, 4)))
  array(as.numeric(flat_img), dim = c(120, 120, 3)) # (120, 120, 4)
}

plotImg <- function(img_raster) {
  # Plot using ggplot2
  ggplot() +
    annotation_raster(img_raster, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
    theme_void()  # Remove axes for clean visualization
}
```

## PCA

```{r}
## PCA
# Defaults: center = TRUE, scale. = FALSE
PCA = prcomp(images[,-1], center = TRUE, scale. = FALSE) #scale = TRUE)

sum_PCA = summary(PCA)
```

```{r}
## Biplot
# Colours
stats$type1 = factor(stats$type1)
# unique(stats$type1)
type_colours = c("#7AC74C", "#EE8130", "#6390F0", "#A6B91A", "#A8A77A", "#A33EA1",
            "#F7D02C", "#E2BF65", "#D685AD", "#CC2E28", "#F95587", "#B6A136", "#735797",
            "#96D9D6", "#6F35FC", "#705746", "#B7B7CE", "#A98FF3")
names(type_colours) = unique(stats$type1)

# library(ggfortify)
autoplot(PCA, data = cbind(stats$name, stats$type1, images[,-1]), shape = FALSE, color = "stats$type1", label = TRUE, label.label = "stats$name", scale = 0) +
  scale_colour_manual(values = type_colours) +
  theme(legend.position = "none")

# Without labels, just types.
autoplot(PCA, data = cbind(stats$name, stats$type1, images[,-1]), label = FALSE, shape = 16, color = "stats$type1", scale = 0) +
  scale_colour_manual(values = type_colours) +
  theme(legend.position = "none")
```

## Loading Vectors

```{r}
## Smallest PC1 Pokemon
# Extract PCA-transformed data
pca_data <- as.data.frame(PCA$x)  # Convert PCA results to a data frame

# Add Pokémon names and types for reference
pca_data$name <- stats$name  # Ensure stats$name contains Pokémon names
pca_data$type1 <- stats$type1  # Primary type for reference

# Sort by PC1 in ascending order and select the two smallest
smallest_pc1_pokemon <- pca_data[order(pca_data$PC1), ][1:2, ]

# Print result
print(rownames(smallest_pc1_pokemon))
```

```{r}
## PC1
# Extremes
pos1 = plotImg(getImg(images[stats$name == "Wailord", -1]))
pos2 = plotImg(getImg(images[stats$name == "Abomasnow", -1]))
neg1 = plotImg(getImg(images[stats$name == "Elgyem", -1])) # Pikipek
neg2 = plotImg(getImg(images[stats$name == "Geodude", -1])) # Unown
# exPlots = sapply(c(pos1, pos2, neg1, neg2), function(rgba) plotImg(getImg(rgba)))
# (pos1 + pos2) / (neg1 + neg2)
final_plot = (pos1 + labs(title = "Most Positive PC1: Wailord") +
              pos2 + labs(title = "Second Positive PC1: Abomasnow")) /
             (neg1 + labs(title = "Most Negative PC1: Elgyem") +
              neg2 + labs(title = "Second Negative PC1: Geodude"))
print(final_plot)

# Loading Vector
pca = PCA$rotation[,1]
pca_norm = (pca - min(pca)) / (max(pca) - min(pca))
# pca_norm = (pca - mean(pca))/(2 * sd(pca))
# pca_clip = pmax(pmin(pca, 1), 0)
plotImg(getImg(pca_norm))
```

```{r}
## PC2
# Extremes
pos1 = plotImg(getImg(images[stats$name == "Slowking", -1]))
pos2 = plotImg(getImg(images[stats$name == "Gardevoir", -1]))
neg1 = plotImg(getImg(images[stats$name == "Altaria", -1]))
neg2 = plotImg(getImg(images[stats$name == "Swablu", -1]))
# exPlots = sapply(c(pos1, pos2, neg1, neg2), function(rgba) plotImg(getImg(rgba)))
# (pos1 + pos2) / (neg1 + neg2)
final_plot = (pos1 + labs(title = "Most Positive PC1: Slowking") +
              pos2 + labs(title = "Second Positive PC1: Gardevoir")) /
             (neg1 + labs(title = "Most Negative PC1: Altaria") +
              neg2 + labs(title = "Second Negative PC1: Swablu"))
print(final_plot)

# Loading Vector
pca = PCA$rotation[,2]
pca_norm = (pca - min(pca)) / (max(pca) - min(pca))
plotImg(getImg(pca_norm))
```

## Variance Explained

```{r}
## Variance Explained
ve = summary(PCA)$importance[3,]

## Retain PCs
var_retain = 0.8 # % of VE
num_pcs = min(which(ve >= var_retain)); num_pcs
dr_images = data.frame(
  image_path = images$image_path,
  PCA$x[,1:num_pcs]
)

# Plot
barplot(ve)+
  xlab("principal component")+
  ylab("cumulative variance explained")+
  ylim(0, 1)+
  geom_hline(aes(yintercept = 0.9), linewidth = 1, linetype = "dashed") +
  geom_hline(aes(yintercept = 0.95), linewidth = 1, linetype = "dashed", color = "red") +
  geom_vline(xintercept = num_pcs, linetype = "dotted", color = "blue") +  # Highlight selected PC count
  annotate("text", x = num_pcs + 5, y = 0.5, label = paste0(num_pcs, " PCs retained"), color = "blue")
```

## Visualize Compressed Images

```{r}
## Abomasnow
pokemon = which(stats$name == "Abomasnow")
# Original image
og = plotImg(getImg(images[pokemon, -1])) + labs(title = "Original")
# Compressed image
scores = (as.numeric(images[pokemon, -1]) - PCA$center) %*% PCA$rotation
scores_95VE = scores[, 1:num_pcs, drop = FALSE] %*% t(PCA$rotation[, 1:num_pcs]) + PCA$center
# scores_95VE_norm = (scores_95VE - min(scores_95VE)) / (max(scores_95VE) - min(scores_95VE))
scores_95VE_clip = pmax(pmin(scores_95VE, 1), 0)
compressed = plotImg(getImg(scores_95VE_clip)) +
  labs(title = paste("PCA Reconstructed (", num_pcs, " PCs)", sep=""))
# Side by side
sbs = og + compressed
print(sbs)

## Gardevoir
pokemon = which(stats$name == "Gardevoir")
# Original image
og = plotImg(getImg(images[pokemon, -1])) + labs(title = "Original")
# Compressed image
scores = (as.numeric(images[pokemon, -1]) - PCA$center) %*% PCA$rotation
scores_95VE = scores[, 1:num_pcs, drop = FALSE] %*% t(PCA$rotation[, 1:num_pcs]) + PCA$center
# scores_95VE_norm = (scores_95VE - min(scores_95VE)) / (max(scores_95VE) - min(scores_95VE))
scores_95VE_clip = pmax(pmin(scores_95VE, 1), 0)
compressed = plotImg(getImg(scores_95VE_clip)) +
  labs(title = paste("PCA Reconstructed (", num_pcs, " PCs)", sep=""))
# Side by side
sbs = og + compressed
print(sbs)
```

# Clustering

```{r}
#
```

# Classification

```{r}
#
```

# Results

```{r}
#
```

